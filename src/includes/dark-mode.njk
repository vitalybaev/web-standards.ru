<script>
    // Этот код нужен для предотвращения мерцания светлой/темной темы до загрузки и парсинга CSS
    (function () {
        var storageKey = 'dark_mode';
        var classNameDark = 'page--dark-mode';

        function setClassOnDocumentBody(darkMode) {
            if (darkMode) {
                document.querySelector('html').classList.add(classNameDark);
            } else {
                document.querySelector('html').classList.remove(classNameDark);
            }
        }

        var preferDarkQuery = '(prefers-color-scheme: dark)';
        var mql = window.matchMedia(preferDarkQuery);
        var supportsColorSchemeQuery = mql.media === preferDarkQuery;
        var localStorageTheme = null;
        try {
            localStorageTheme = localStorage.getItem(storageKey);
        } catch (err) {}
        var localStorageExists = localStorageTheme !== null;
        if (localStorageExists) {
            localStorageTheme = JSON.parse(localStorageTheme);
        }

        // Определяем источник правды
        if (localStorageExists) {
            // Источник правды - localStorage
            setClassOnDocumentBody(localStorageTheme);
        } else if (supportsColorSchemeQuery) {
            // source of truth from system
            setClassOnDocumentBody(mql.matches);
            try {
                localStorage.setItem(storageKey, mql.matches);
            } catch (e) {}
        } else {
            // source of truth from document.body
            var isDarkMode = document.body.classList.contains(classNameDark);
            try {
                localStorage.setItem(storageKey, JSON.stringify(isDarkMode));
            } catch (e) {}
        }
    })();
</script>
